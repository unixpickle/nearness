package main

import (
	"math"
	"math/rand"
)

const (
	ExploiterDecay   = 0.999999
	ExploiterEpsilon = 0.1
)

type Exploiter struct {
	utility map[int]float64
}

func NewExploiter(minSize, maxSize int) *Exploiter {
	res := &Exploiter{utility: map[int]float64{}}
	for i := minSize; i <= maxSize; i++ {
		res.utility[i] = 0
	}
	return res
}

func (e *Exploiter) Sample() int {
	if rand.Float64() < ExploiterEpsilon {
		return e.sampleRandom()
	}
	var best []int
	bestUtility := math.Inf(-1)
	for i, u := range e.utility {
		if u > bestUtility {
			bestUtility = u
			best = []int{i}
		} else if u == bestUtility {
			best = append(best, i)
		}
	}
	return best[rand.Intn(len(best))]
}

func (e *Exploiter) sampleRandom() int {
	var sizes []int
	for size := range e.utility {
		sizes = append(sizes, size)
	}
	return sizes[rand.Intn(len(sizes))]
}

func (e *Exploiter) GotUtility(size int, utility float64) {
	u := e.utility[size]
	u += math.Log(ExploiterDecay)
	u = math.Log(math.Exp(u) + utility)
	e.utility[size] = u
}
